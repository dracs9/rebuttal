{% extends 'base.html' %}
{% load static %}

{% block title %}
  {{ speech.title }} - Debate Coach AI
{% endblock %}

{% block content %}
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Back to Dashboard -->
    <div class="mb-6">
      <a href="{% url 'dashboard' %}" class="text-indigo-600 hover:text-indigo-900"><i class="fas fa-arrow-left mr-2"></i>Back to Dashboard</a>
    </div>

    <!-- Speech Header -->
    <div class="bg-white shadow overflow-hidden sm:rounded-lg mb-8">
      <div class="px-4 py-5 sm:px-6">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="text-lg leading-6 font-medium text-gray-900">{{ speech.title }}</h3>
            <p class="mt-1 max-w-2xl text-sm text-gray-500">Uploaded on {{ speech.upload_date|date:'F j, Y, g:i a' }}</p>
          </div>
          <div>
            <span class="px-3 py-1 rounded-full text-sm font-medium
              {% if speech.status == 'completed' %}
                
                bg-green-100 text-green-800

              {% elif speech.status == 'processing' %}
                
                bg-yellow-100 text-yellow-800

              {% elif speech.status == 'failed' %}
                
                bg-red-100 text-red-800

              {% else %}
                
                bg-gray-100 text-gray-800

              {% endif %}">
              {{ speech.get_status_display }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Audio Player -->
    <div class="bg-white shadow sm:rounded-lg mb-8">
      <div class="px-4 py-5 sm:p-6">
        <h4 class="text-lg font-medium text-gray-900 mb-4">Audio Recording</h4>
        <audio controls class="w-full">
          <source src="{{ speech.audio_file.url }}" type="audio/mpeg" />Your browser does not support the audio element.
        </audio>
      </div>
    </div>

    <!-- Transcript Section -->
    <div class="bg-white shadow sm:rounded-lg mb-8" id="transcript-section">
      <div class="px-4 py-5 sm:p-6">
        <h4 class="text-lg font-medium text-gray-900 mb-4">Transcript</h4>
        {% if speech.status == 'completed' %}
          <div class="prose max-w-none">{{ speech.transcript|linebreaks }}</div>
        {% elif speech.status == 'processing' %}
          <div class="flex items-center justify-center py-8">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
            <span class="ml-3 text-gray-600">Processing your speech...</span>
          </div>
        {% elif speech.status == 'failed' %}
          <div class="bg-red-50 border-l-4 border-red-400 p-4">
            <div class="flex">
              <div class="flex-shrink-0">
                <i class="fas fa-exclamation-circle text-red-400"></i>
              </div>
              <div class="ml-3">
                <p class="text-sm text-red-700">{{ speech.error_message }}</p>
              </div>
            </div>
          </div>
        {% else %}
          <div class="text-gray-500 text-center py-8">Transcript will appear here once processing is complete.</div>
        {% endif %}
      </div>
    </div>
  </div>

  {% if speech.status == 'processing' %}
    <script>
      function checkStatus() {
        fetch("{% url 'speech_status' speech.id %}")
          .then((response) => response.json())
          .then((data) => {
            if (data.status === 'completed') {
              window.location.reload()
            } else if (data.status === 'failed') {
              window.location.reload()
            } else {
              setTimeout(checkStatus, 2000)
            }
          })
      }
      
      // Start checking status
      checkStatus()
    </script>
  {% endif %}
{% endblock %}
